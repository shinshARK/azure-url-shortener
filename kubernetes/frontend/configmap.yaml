apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-caddy-config
  labels:
    app: frontend
data:
  Caddyfile: |
    {
        email jidanabdurahman@gmail.com
        acme_ca https://acme.zerossl.com/v2/DV90
    }
    lazurune.shinshark.my.id {
        # 1. API Routes
        handle /api/auth* {
            reverse_proxy http://auth-service
        }

        handle /api/links* {
            reverse_proxy http://link-management-service
        }

        handle /api/analytics* {
            reverse_proxy http://analytics-query-service:3001
        }

        # 2. Frontend Assets & Routes (Explicit Whitelist)
        # We handle these explicitly so everything else can fall through to the Redirect Service
        @frontend path / /login /register /dashboard /assets/* /favicon.ico /favicon.png
        handle @frontend {
            root * /srv
            try_files {path} /index.html
            file_server
        }

        # 3. Everything else -> Redirect Service (Azure Function)
        # This allows root-level short links (e.g., domain.com/AbCd)
        handle {
            rewrite * /api{path}
            reverse_proxy https://us-func-p6ndmuotrzo5a.azurewebsites.net {
                header_up Host {upstream_hostport}
            }
        }
    }
