apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-caddy-config
  labels:
    app: frontend
data:
  Caddyfile: |
    {
        email jidanabdurahman@gmail.com
        acme_ca https://acme.zerossl.com/v2/DV90
    }
    lazurune.shinshark.my.id {
        root * /srv
        encode gzip

        # 1. API Routes (Keep these at the top)
        handle /api/auth* { 
            reverse_proxy http://auth-service 
        }
        handle /api/links* { 
            reverse_proxy http://link-management-service 
        }
        handle /api/analytics* { 
            reverse_proxy http://analytics-query-service:3001 
        }

        # 2. FILE SERVER (The "Smart" Fix)
        # If the request matches a real file on disk (like favicon.png), serve it immediately.
        @static_file {
            file
        }
        handle @static_file {
            file_server
        }

        # 3. Frontend Routes (SPA)
        # If it's not a file, but matches our Vue routes, serve index.html
        @frontend path / /login /register /dashboard
        handle @frontend {
            try_files {path} /index.html
            file_server
        }

        # 4. Everything else -> Redirect Service
        handle {
            rewrite * /api{path}
            reverse_proxy https://us-func-p6ndmuotrzo5a.azurewebsites.net {
                header_up Host {upstream_hostport}
            }
        }
    }
